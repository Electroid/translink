!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("fs")},function(e,t,r){const n=r(3),o=r(5);var i,s;function a(){return s.assertTable("bus",["vehicle INT NOT NULL","trip BIGINT NOT NULL","route SMALLINT NOT NULL","direction CHAR(16) NOT NULL","destination CHAR(64) NOT NULL","pattern CHAR(16) NOT NULL","latitude DECIMAL(9,6) NOT NULL","longitude DECIMAL(9,6) NOT NULL","time DATETIME NOT NULL","PRIMARY KEY (trip, time)"]).then(()=>i.buses).then(e=>(console.log(e),e)).then(e=>s.insertRow("bus",e)).then(()=>s.close())}r(12),new Date<0&&r(14),i=new n(env("TRANSLINK_API_KEY")),s=new o(env("SQL_GOOGLE_ID"),env("SQL_HOSTNAME"),env("SQL_DATABASE"),env("SQL_USERNAME"),env("SQL_PASSWORD"),env("SQL_GOOGLE_KEY")),production()?t.event=function(e,t){var r=null;if(e)try{r=Buffer.from(e.data,"base64").toString()}catch(t){r=e.toString()}return"download"===r?a():"upload"===r?s.exportToBigQuery("bus",`bus/${n.getLocalTime().format()}`):Promise.reject(new Error(`Unknown message: ${r}`))}:a().catch(e=>console.error(e))},function(e,t,r){const n=r(0),o=r(4),i="America/Vancouver";class s{constructor(e){this.apiKeys=e.split(",")}get apiKey(){return this.apiKeys[Math.floor(Math.random()*this.apiKeys.length)]}fetch(e,t={}){t.apikey=this.apiKey;var r=Object.keys(t).map(e=>`${e}=${t[e]}`).join("&");return n(`https://api.translink.ca/rttiapi/v1/${e}?${r}`,{simple:!0,json:!0,timeout:5e3})}get buses(){return this.fetch("buses").then(e=>e.map(e=>s.parseBus(e)).filter(Boolean))}static parseBus(e){try{var t={vehicle:parseInt(e.VehicleNo),trip:parseInt(e.TripId),route:parseInt(e.RouteNo.replace("N","-")),direction:e.Direction,destination:e.Destination,pattern:e.Pattern,latitude:parseFloat(e.Latitude),longitude:parseFloat(e.Longitude),time:s.parseLocalTime(e.RecordedTime)};if(0!=t.longitude&&0!=t.latitude)return t}catch(t){console.error(`Could not process bus ${e} because of ${t}`)}return null}static getLocalTime(e=null){return e?o(e).tz(i):o().tz(i)}static parseLocalTime(e){var t=s.getLocalTime().format("YYYY-MM-DD"),r=s.getLocalTime(t).unix();production()&&(r+=28800);var[n,o]=e.split(" "),[i,a,u]=n.split(":").map(e=>parseInt(e));return"pm"===o&&i<12?i+=12:"am"===o&&12==i&&(i-=12),r+=60*i*60,r+=60*a,(r+=u)>Date.now()/1e3&&(r-=86400),s.getLocalTime(1e3*r).format()}}e.exports=s},function(e,t){e.exports=require("moment-timezone")},function(e,t,r){const n=r(1),o=r(0),i=r(6),s=r(7),a=r(8),{Storage:u}=r(9),c=r(10);e.exports=class extends c{constructor(e,t,r,o,i,c){super(t,r,o,i),this.id=e,this.name=r,c=JSON.parse(Buffer.from(c,"base64"));var l,p=`google-${e}.json`;this.projectId=c.project_id,this.client=new s.JWT(c.client_email,null,c.private_key,["https://www.googleapis.com/auth/sqlservice.admin","https://www.googleapis.com/auth/cloud-platform"],null),production()?l={projectId:this.projectId}:(l={projectId:this.projectId,keyFilename:p},n.writeFileSync(p,JSON.stringify(c))),this.bigQuery=new a(l),this.storage=new u(l)}request(e,t=null){return this.client.authorize().then(r=>o({url:e,json:t,headers:{"content-type":"application/json"},auth:{bearer:r.access_token},method:t?"POST":"GET",simple:!0})).then(e=>"string"==typeof e?JSON.parse(e):e)}wait(e,t=10){return this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/operations/${e}`).then(r=>{if(r.error)throw new Error(r.error.errors[0].message);return r.endTime?r:i(1e3*t).then(r=>this.wait(e,2*t))})}getDataset(e){return this.bigQuery.dataset(this.name).get({autoCreate:!0}).then(t=>t[0].table(e).get({autoCreate:!0})).then(e=>e[0])}getBucket(){return this.storage.bucket(this.name).get({autoCreate:!0}).then(e=>e[0])}exportToCsv(e,t){return this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/instances/${this.id}`).then(e=>this.getBucket().then(t=>t.acl.update({entity:`user-${e.serviceAccountEmailAddress}`,role:"WRITER"}))).then(()=>this.showColumns(e)).then(r=>this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/instances/${this.id}/export`,{exportContext:{fileType:"CSV",uri:`gs://${this.name}/${t}.csv`,databases:[this.name],csvExportOptions:{selectQuery:[`SELECT '${r.join("','")}'`,"UNION ALL",`SELECT * FROM ${e}`].join("\n")}}})).then(e=>this.wait(e.name))}exportToBigQuery(e,t){return this.exportToCsv(e,t).then(r=>this.getDataset(e).then(e=>this.getBucket().then(r=>e.load(r.file(`${t}.csv`),{autodetect:!0,maxBadRecords:100,sourceFormat:"CSV",writeDisposition:"WRITE_TRUNCATE",nullMarker:"null",skipLeadingRows:1})))).then(e=>e[0])}}},function(e,t){e.exports=require("sleep-promise")},function(e,t){e.exports=require("google-auth-library")},function(e,t){e.exports=require("@google-cloud/bigquery")},function(e,t){e.exports=require("@google-cloud/storage")},function(e,t,r){const n=r(11),o=r(1);class i{constructor(e,t,r,n){this.fields={},this.login={host:e,database:t,user:r,password:n,connectionLimit:5}}connection(){return this.db?this.db:this.db=n.createPool(this.login)}query(e){return this.connection().query(e)}queryFromFile(e){var t=`../sql/${e}.sql`;return new Promise((e,r)=>{o.readFile(t,"utf8",(t,n)=>{t?r(t):e(n)})}).then(e=>this.query(e))}assertTable(e,t){return this.query(`CREATE TABLE IF NOT EXISTS ${e} (${t.join(",")})`).then(()=>this.showColumns(e))}showColumns(e){return this.query(`SHOW COLUMNS FROM ${e}`).then(e=>e.map(e=>e.Field))}insertRow(e,t){return(t=t.map(e=>i.normalize(e)))[0]instanceof Array||(t=[t]),t=t.map(e=>`(${e.join(",")})`),this.query(`INSERT IGNORE INTO ${e} VALUES ${t.join(",")}`)}close(){if(this.db){var e=this.db;return this.db=null,e.end()}return Promise.resolve()}static normalize(e){return Object.values(e).map(e=>null==e||null==e?"null":"string"==typeof e?`'${e.replace("'","''")}'`:isNaN(e)?0:e)}}e.exports=i},function(e,t){e.exports=require("promise-mysql")},function(e,t,r){global.dev=function(){return!process.env.GOOGLE},global.production=function(){return!dev()},global.env=function(e){return production()?process.env[e]:r(13)(e.replace(/.*/,"../secret.json"))[e]}},function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=13},function(e,t){e.exports="CREATE TABLE IF NOT EXISTS bus (\n    vehicle INT NOT NULL,\n    trip BIGINT NOT NULL,\n    route SMALLINT NOT NULL,\n    direction CHAR(16) NOT NULL,\n    destination CHAR(64) NOT NULL,\n    pattern CHAR(16) NOT NULL,\n    latitude DECIMAL(9,6) NOT NULL,\n    longitude DECIMAL(9,6) NOT NULL,\n    time DATETIME NOT NULL,\n    PRIMARY KEY (trip, time)\n)\n"}]));