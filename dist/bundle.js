!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(o,i,function(t){return e[t]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t){e.exports=require("request-promise")},function(e,t,r){const o=r(2),i=r(4);function s(e){return process.env[e]}t.event=((e,t)=>{var r=new o(s("TRANSLINK_API_KEY")),n=new i(s("SQL_GOOGLE_ID"),s("SQL_HOSTNAME"),s("SQL_DATABASE"),s("SQL_USERNAME"),s("SQL_PASSWORD"),s("SQL_GOOGLE_KEY"));n.assertTable("bus",["vehicle INT NOT NULL","trip BIGINT NOT NULL","route SMALLINT NOT NULL","direction CHAR(16) NOT NULL","destination CHAR(64) NOT NULL","pattern CHAR(16) NOT NULL","latitude DECIMAL(9,6) NOT NULL","longitude DECIMAL(9,6) NOT NULL","time DATETIME NOT NULL","PRIMARY KEY (trip, time)"]).then(()=>{var t=Buffer.from(e.data,"base64").toString();"import"===t?r.buses.then(e=>n.insertRow("bus",e)):"export"===t&&n.exportToBigQuery("bus",`bus/${o.getLocalTime().format()}`)})})},function(e,t,r){const o=r(0),i=r(3);class s{constructor(e){this.apiKeys=e.split(","),this.apiKeyCursor=0}get apiKey(){return this.apiKeys[Math.floor(Math.random()*this.apiKeys.length)]}fetch(e,t={}){t.apikey=this.apiKey;var r=Object.keys(t).map(e=>`${e}=${t[e]}`).join("&");return o(`https://api.translink.ca/rttiapi/v1/${e}?${r}`,{simple:!0,json:!0,timeout:3e4})}get buses(){return this.fetch("buses").then(e=>e.map(e=>s.parseBus(e)).filter(Boolean))}static parseBus(e){try{var t={vehicle:parseInt(e.VehicleNo),trip:parseInt(e.TripId),route:parseInt(e.RouteNo.replace("N","-")),direction:e.Direction,destination:e.Destination,pattern:e.Pattern,latitude:parseFloat(e.Latitude),longitude:parseFloat(e.Longitude),time:s.parseLocalTime(e.RecordedTime).toISOString()};if(0!=t.longitude&&0!=t.latitude)return t}catch(t){console.error(`Could not process bus ${e} because of ${t}`)}return null}static getLocalTime(){return i().tz("America/Vancouver")}static parseLocalTime(e){var[t,r]=e.split(" "),o=s.getLocalTime(),i=o.format("YYYY-MM-DD"),n=o.toDate().getTimezoneOffset()%60,a=new Date(`${i}T${t}.000${n}`);return"pm"==r&&a.setMilliseconds(a.getMilliseconds()+432e5),a>o.toDate()&&a.setMilliseconds(a.getMilliseconds()-864e5),a}}e.exports=s},function(e,t){e.exports=require("moment-timezone")},function(e,t,r){const o=r(5),i=r(0),s=r(6),n=r(7),a=r(8),{Storage:u}=r(9),c=r(10);e.exports=class extends c{constructor(e,t,r,i,s,c){super(t,r,i,s),this.id=e,this.name=r,c=JSON.parse(Buffer.from(c,"base64"));var l,p=`google-${e}.json`;this.projectId=c.project_id,this.client=new n.JWT(c.client_email,null,c.private_key,["https://www.googleapis.com/auth/sqlservice.admin","https://www.googleapis.com/auth/cloud-platform"],null),process.env.GOOGLE?l={projectId:this.projectId}:(l={projectId:this.projectId,keyFilename:p},o.writeFileSync(p,c)),this.bigQuery=new a(l),this.storage=new u(l)}request(e,t=null){return this.client.authorize().then(r=>i({url:e,json:t,headers:{"content-type":"application/json"},auth:{bearer:r.access_token},method:t?"POST":"GET",simple:!0})).then(e=>"string"==typeof e?JSON.parse(e):e)}wait(e,t=10){return this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/operations/${e}`).then(r=>{if(r.error)throw new Error(r.error.errors[0].message);return r.endTime?r:s(1e3*t).then(r=>this.wait(e,2*t))})}getDataset(e){return this.bigQuery.dataset(this.name).get({autoCreate:!0}).then(t=>t[0].table(e).get({autoCreate:!0})).then(e=>e[0])}getBucket(){return this.storage.bucket(this.name).get({autoCreate:!0}).then(e=>e[0])}exportToCsv(e,t){return this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/instances/${this.id}`).then(e=>this.getBucket().then(t=>t.acl.update({entity:`user-${e.serviceAccountEmailAddress}`,role:"WRITER"}))).then(r=>this.request(`https://www.googleapis.com/sql/v1beta4/projects/${this.projectId}/instances/${this.id}/export`,{exportContext:{fileType:"CSV",uri:`gs://${this.name}/${t}.csv`,databases:[this.name],csvExportOptions:{selectQuery:[`SELECT '${this.fields[e].join("','")}'`,"UNION ALL",`SELECT * FROM ${e}`].join("\n")}}})).then(e=>this.wait(e.name))}exportToBigQuery(e,t){return this.exportToCsv(e,t).then(r=>this.getDataset(e).then(e=>this.getBucket().then(r=>e.load(r.file(`${t}.csv`),{autodetect:!0,maxBadRecords:100,sourceFormat:"CSV",writeDisposition:"WRITE_TRUNCATE",nullMarker:"null",skipLeadingRows:1})))).then(e=>e[0])}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("sleep-promise")},function(e,t){e.exports=require("google-auth-library")},function(e,t){e.exports=require("@google-cloud/bigquery")},function(e,t){e.exports=require("@google-cloud/storage")},function(e,t,r){const o=r(11);class i{constructor(e,t,r,i){this.fields={},this.db=o.createPool({host:e,database:t,user:r,password:i,connectionLimit:5})}query(e){return this.db.query(e)}assertTable(e,t){return this.query(`CREATE TABLE IF NOT EXISTS ${e} (${t.join(",")});`).then(t=>this.query(`SHOW COLUMNS FROM ${e}`).then(t=>this.fields[e]=t.map(e=>e.Field)))}insertRow(e,t){return(t=t.map(e=>i.normalize(e)))[0]instanceof Array||(t=[t]),t=t.map(e=>`(${e.join(",")})`),this.query(`INSERT IGNORE INTO ${e} VALUES ${t.join(",")};`)}static normalize(e){return Object.values(e).map(e=>null==e||null==e?"null":"string"==typeof e?`'${e.replace("'","''")}'`:isNaN(e)?0:e)}}e.exports=i},function(e,t){e.exports=require("promise-mysql")}]));